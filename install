#!/bin/bash

# Frigate Alerts Service Installer
# Usage:
#   ./install          - Install and enable service
#   ./install status   - Show service status
#   ./install enable   - Enable service
#   ./install disable  - Disable service
#   ./install start    - Start service
#   ./install stop     - Stop service
#   ./install restart  - Restart service
#   ./install logs     - Show service logs
#   ./install uninstall - Remove service

set -e

SERVICE_NAME="frigate-alerts"
SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"
APP_DIR="$(cd "$(dirname "$0")" && pwd)"
NODE_PATH=$(which node 2>/dev/null || echo "/usr/bin/node")

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_status() {
    echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

check_root() {
    if [ "$EUID" -ne 0 ]; then
        print_error "This command requires root privileges. Please run with sudo."
        exit 1
    fi
}

check_node() {
    if ! command -v node &> /dev/null; then
        print_error "Node.js is not installed. Please install Node.js first."
        exit 1
    fi
    print_info "Node.js found at: $(which node)"
}

check_config() {
    if [ ! -f "$APP_DIR/config.json" ]; then
        print_error "config.json not found!"
        print_info "Please create config.json based on config.example.json"
        exit 1
    fi
    print_status "config.json found"
}

install_dependencies() {
    print_info "Installing npm dependencies..."
    cd "$APP_DIR"
    npm install --production
    print_status "Dependencies installed"
}

create_service_file() {
    local user="${SUDO_USER:-$USER}"
    local group=$(id -gn "$user")
    
    cat > "$SERVICE_FILE" << EOF
[Unit]
Description=Frigate Alerts - Telegram notification service for Frigate NVR
After=network.target

[Service]
Type=simple
User=$user
Group=$group
WorkingDirectory=$APP_DIR
ExecStart=$NODE_PATH $APP_DIR/index.js
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
Environment=NODE_ENV=production
Environment=CONFIG_PATH=$APP_DIR/config.json

[Install]
WantedBy=multi-user.target
EOF

    print_status "Service file created at $SERVICE_FILE"
}

install_service() {
    check_root
    check_node
    check_config
    
    echo ""
    print_info "Installing Frigate Alerts service..."
    echo ""
    
    install_dependencies
    create_service_file
    
    systemctl daemon-reload
    print_status "Systemd daemon reloaded"
    
    systemctl enable "$SERVICE_NAME"
    print_status "Service enabled"
    
    systemctl start "$SERVICE_NAME"
    print_status "Service started"
    
    echo ""
    print_status "Installation complete!"
    echo ""
    print_info "Useful commands:"
    echo "  ./install status   - Check service status"
    echo "  ./install logs     - View service logs"
    echo "  ./install restart  - Restart service"
    echo "  ./install stop     - Stop service"
    echo ""
}

uninstall_service() {
    check_root
    
    print_info "Uninstalling Frigate Alerts service..."
    
    if systemctl is-active --quiet "$SERVICE_NAME" 2>/dev/null; then
        systemctl stop "$SERVICE_NAME"
        print_status "Service stopped"
    fi
    
    if systemctl is-enabled --quiet "$SERVICE_NAME" 2>/dev/null; then
        systemctl disable "$SERVICE_NAME"
        print_status "Service disabled"
    fi
    
    if [ -f "$SERVICE_FILE" ]; then
        rm "$SERVICE_FILE"
        print_status "Service file removed"
    fi
    
    systemctl daemon-reload
    print_status "Systemd daemon reloaded"
    
    echo ""
    print_status "Uninstallation complete!"
}

show_status() {
    echo ""
    print_info "Service Status: $SERVICE_NAME"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    
    if [ -f "$SERVICE_FILE" ]; then
        print_status "Service is installed"
    else
        print_warning "Service is not installed"
        echo ""
        print_info "Run './install' to install the service"
        return
    fi
    
    if systemctl is-enabled --quiet "$SERVICE_NAME" 2>/dev/null; then
        print_status "Service is enabled (will start on boot)"
    else
        print_warning "Service is disabled (won't start on boot)"
    fi
    
    if systemctl is-active --quiet "$SERVICE_NAME" 2>/dev/null; then
        print_status "Service is running"
    else
        print_warning "Service is not running"
    fi
    
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    systemctl status "$SERVICE_NAME" --no-pager || true
}

show_logs() {
    journalctl -u "$SERVICE_NAME" -f --no-pager
}

# Main command handler
case "${1:-install}" in
    install)
        install_service
        ;;
    uninstall|remove)
        uninstall_service
        ;;
    status)
        show_status
        ;;
    start)
        check_root
        systemctl start "$SERVICE_NAME"
        print_status "Service started"
        ;;
    stop)
        check_root
        systemctl stop "$SERVICE_NAME"
        print_status "Service stopped"
        ;;
    restart)
        check_root
        systemctl restart "$SERVICE_NAME"
        print_status "Service restarted"
        ;;
    enable)
        check_root
        systemctl enable "$SERVICE_NAME"
        print_status "Service enabled (will start on boot)"
        ;;
    disable)
        check_root
        systemctl disable "$SERVICE_NAME"
        print_status "Service disabled (won't start on boot)"
        ;;
    logs)
        show_logs
        ;;
    *)
        echo "Frigate Alerts Service Manager"
        echo ""
        echo "Usage: $0 [command]"
        echo ""
        echo "Commands:"
        echo "  install     Install and start the service (default)"
        echo "  uninstall   Remove the service"
        echo "  status      Show service status"
        echo "  start       Start the service"
        echo "  stop        Stop the service"
        echo "  restart     Restart the service"
        echo "  enable      Enable service (start on boot)"
        echo "  disable     Disable service (don't start on boot)"
        echo "  logs        Show service logs (live)"
        echo ""
        exit 1
        ;;
esac


